@page "/"
@using EmployeeManager.Services
@using EmployeeManager.ViewModels
@inject EmployeeViewService EmployeeService
@inject ILogger<Index> Logger
@inject AppState AppState
@inject IDialogService DialogService

<PageTitle>Employee Manager</PageTitle>

<MudStack>

    <MudPaper Class="pa-4 d-flex align-center gap-4">
        <MudIcon Icon="@Icons.Filled.PermContactCalendar" Size="Size.Large" Color="Color.Primary"/>
        <MudText Typo="Typo.h4">Employee Manager</MudText>
        <MudSpacer/>
        <MudIconButton Icon="@Icons.Filled.Settings" OnClick="@(() => DialogService.Show<Settings>("Settings"))"/>
    </MudPaper>

    @if (_employees is not null && _employees.Any())
    {
        <MudPaper Class="pa-4 d-flex justify-center">
            <MudPagination Count="@TotalPages" SelectedChanged="@ChangePage"/>
        </MudPaper>

        <MudPaper Class="pa-4">
            <MudStack>
                @foreach (var employee in _employees)
                {
                    <MudStack Row="true">
                        <MudIcon Size="Size.Small" Icon="@(employee.IsMale ? Icons.Filled.Male : Icons.Filled.Female)"
                                 Color="@(employee.IsMale ? Color.Tertiary : Color.Secondary)"/>
                        <MudText>
                            @employee.JobTitle <strong>@employee.FirstName @employee.LastName</strong>
                        </MudText>
                        <MudIcon Size="Size.Small" Icon="@Icons.Filled.AttachMoney" Color="Color.Success"/>
                        <MudText>@employee.Salary</MudText>
                        <MudIcon Size="Size.Small" Icon="@Icons.Filled.Assignment" Color="Color.Warning"/>
                        <MudText>@employee.DepartmentName</MudText>
                    </MudStack>
                }
            </MudStack>
        </MudPaper>
    }
    else
    {
        <MudPaper Class="pa-4">
            <MudButton Color="Color.Primary" OnClick="LoadEmployees">Load Employees</MudButton>
        </MudPaper>
    }

</MudStack>

@code
{
    int _selectedPage = 1;

    IEnumerable<EmployeeView>? _employees;

    int TotalPages => EmployeeService.GetEmployeesCount() / AppState.ItemsPerPage + 1;

    int Offset => (_selectedPage - 1) * AppState.ItemsPerPage;

    void LoadEmployees()
    {
        Logger.LogInformation("Loading employees (page {Page}, offset {Offset})", _selectedPage, Offset);
        _employees = EmployeeService.GetEmployees(Offset, AppState.ItemsPerPage);
    }

    private void ChangePage(int page)
    {
        Logger.LogInformation("Changing page to {Page}", page);
        _selectedPage = page;
        LoadEmployees();
    }
}